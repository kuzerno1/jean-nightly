name: Nightly Build

on:
  workflow_dispatch: # Manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      changelog: ${{ steps.changelog.outputs.content }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Sync upstream and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote get-url upstream >/dev/null 2>&1 || git remote add upstream https://github.com/coollabsio/jean.git
          git fetch upstream
          UPSTREAM_SHA=$(git rev-parse upstream/main)
          if git subtree pull --prefix=jean upstream main --squash -m "chore: sync upstream

          Synced from: $UPSTREAM_SHA"; then
            git push origin main
          else
            echo "Already up to date or no changes to sync"
          fi

      - name: Generate changelog
        id: changelog
        run: |
          git remote get-url upstream >/dev/null 2>&1 || git remote add upstream https://github.com/coollabsio/jean.git
          git fetch upstream

          # Get current upstream HEAD
          CURRENT_SHA=$(git rev-parse upstream/main)

          # Get last synced upstream commit from previous subtree merge.
          # If the latest sync already matches CURRENT_SHA, use the previous one.
          SYNC_SHAS=$(git log --grep="Synced from:" --format="%b" 2>/dev/null | grep -oE '[a-f0-9]{40}' || true)
          LATEST_SHA=$(printf '%s\n' "$SYNC_SHAS" | head -1)
          PREV_SHA=$(printf '%s\n' "$SYNC_SHAS" | sed -n '2p')
          if [ -n "$LATEST_SHA" ] && [ "$LATEST_SHA" = "$CURRENT_SHA" ] && [ -n "$PREV_SHA" ]; then
            LAST_SHA="$PREV_SHA"
          else
            LAST_SHA="$LATEST_SHA"
          fi

          if [ -n "$LAST_SHA" ] && [ "$LAST_SHA" != "$CURRENT_SHA" ]; then
            # Generate changelog from upstream repo commits
            {
              echo 'content<<EOF'
              echo "### Changes from upstream"
              echo ""
              git log --oneline "$LAST_SHA..$CURRENT_SHA" 2>/dev/null | head -50 | while IFS= read -r line; do
                echo "- $line"
              done
              echo ""
              echo "[Full diff](https://github.com/coollabsio/jean/compare/${LAST_SHA}...${CURRENT_SHA})"
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo 'content<<EOF'
              echo "No new changes from upstream since last sync."
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          fi

  build:
    needs: sync
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: "--target universal-apple-darwin --bundles app,dmg"
          - platform: windows-latest
            args: "--bundles msi,nsis"

    runs-on: ${{ matrix.platform }}
    defaults:
      run:
        working-directory: jean

    steps:
      - uses: actions/checkout@v4

      - name: Apply patches
        run: |
          set -e
          for patch in patches/*.patch; do
            if [ -f "$patch" ]; then
              echo "Applying patch: $patch"
              git apply --directory=jean "$patch"
            fi
          done
        shell: bash
        working-directory: ${{ github.workspace }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: jean/package-lock.json

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add macOS targets
        if: matrix.platform == 'macos-latest'
        run: |
          rustup target add aarch64-apple-darwin
          rustup target add x86_64-apple-darwin

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "./jean/src-tauri -> target"

      - name: Install dependencies
        run: npm ci

      - name: Build and Release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          projectPath: jean
          tauriScript: npm run tauri
          tagName: nightly-${{ github.run_number }}
          releaseName: "Nightly Build #${{ github.run_number }}"
          releaseBody: |
            ## Nightly Build

            Built from main branch with local patches applied.

            ${{ needs.sync.outputs.changelog }}

            **Note:** This is an automated nightly build.
          releaseDraft: false
          prerelease: true
          includeUpdaterJson: true
          args: ${{ matrix.args }}
